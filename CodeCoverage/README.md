# Code Coverage Tools

The scripts `codecoverage_post-test.py` and `codecoverage_post-all.py` are compatible with the SAS V&V test suite `SASTest.py` script 
and can be used to create code coverage reports for the test suite. The SAS V&V test suite can be obtained 
from the Argonne S&TPO office. 

The Intel code coverage tool is documented [here](https://www.intel.com/content/www/us/en/docs/fortran-compiler/developer-guide-reference/2023-0/code-coverage-tool.html).

Both scripts using the following options when running the code coverage tool to specify markings used to exclude single lines and blocks of code from the coverage analysis: <br>
-onelinedsbl NO_COVER <br>
-beginblkdsbl BEGIN_EXCLUDE <br>
-endblkdsbl END_EXCLUDE <br>

To exclude a single line of source code from the coverage analysis, add the comment "! // NO_COVER" to the end of the line. 

To define boundaries where the code in between is excluded from the coverage analysis, add the comment "! // BEGIN_EXCLUDE"
at the start of the code and the comment "! // END_EXCLUDE" at the end. 

After adding the comments, make sure to recompile the instrumented executable. 

## Using codecoverage_post-test.py
This script generates a code coverage report for each test case that is run. 
1. Compile an instrumented SAS executable using the `make coverage` target. 
2. Run `SASTest.py` using the instrumented executable and use the `--post-test` option to execute the post-test code coverage script after
each test case is run. For example:
`./SASTest.py -x instrumented-sas.x --post-test "codecoverage_post-test.py" TestSuite`

3. The optional argument `--comp` can be added to the post-test code coverage script, which specifies the path of a file that specifies the source code files to be included or excluded in the code coverage reports. This is the `-compfile` option described in the Intel code 
coverage tool documentation. For example:
`./SASTest.py -x instrumented-sas.x --post-test "codecoverage_post-test.py --comp compfile.txt" TestSuite`

4. The test suite will run as usual and a code coverage report will be generated for each test in it's "run" directory. 

## Using codecoverage_post-all.py
This script post-processes the individual code coverage reports generated by `codecoverage_post-test.py` to create a report 
that shows the cumulative code coverage of all the test cases that were run, and has links to the individual code coverage reports
from each test case. To use this script, first install the BeautifulSoup package by running `pip install bs4`. 

1. Run `SASTest.py` using the instrumented executable and use the `--post-all` option to execute the post-all code coverage script after all test cases have been run. For example:
`./SASTest.py -x instrumented-sas.x --post-test "codecoverage_post-test.py" --post-all "codecoverage_post-all.py" TestSuite`

2. The post-all script also has the same optional `--comp` argument, and the same input should be used as with the post-test script. For example:
`./SASTest.py -x instrumented-sas.x --post-test "codecoverage_post-test.py --comp compfile.txt" --post-all "codecoverage_post-all.py --comp compfile.txt" TestSuite`

3. To add unit test coverage to the cumulative report, use the optional `--unitbuild` argument to specify the directory containing .dyn files from unit test execution. This is likely `test/build/Darwin-x86_64-coverage` (path would differ depending on OS) if the unit tests were run using the `make test-coverage` target in the SAS makefile. 

4. By default, the cumulative code coverage report will be generated in a folder labeled using a timestamp. To specify the folder name, use the optional input `--outdir`. The script will not overwrite an existing report with a new one unless the optional argument `--overwrite` is used. For example:
`./SASTest.py -x instrumented-sas.x --post-test "codecoverage_post-test.py" --post-all "codecoverage_post-all.py --outdir MYREPORT --overwrite" TestSuite`
